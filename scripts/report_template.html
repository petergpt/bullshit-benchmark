<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bullshit Benchmark Report</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap");

    :root {
      --bg: #f2f3ef;
      --ink: #132026;
      --ink-soft: #4e646c;
      --line: #d6deda;
      --card: #fbfcfa;
      --card-strong: #ffffff;
      --accent: #0f6b68;
      --accent-2: #1d8f89;
      --good: #1f9d72;
      --warn: #d7822d;
      --bad: #c94e42;
      --info: #1f5f9d;
      --shadow: 0 10px 28px rgba(16, 35, 42, 0.08);
      --radius: 14px;
      --mono: "IBM Plex Mono", "SFMono-Regular", Menlo, monospace;
      --sans: "Sora", "Avenir Next", "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at -12% -15%, #dce8e1 0%, transparent 60%),
        radial-gradient(900px 500px at 105% -10%, #dfe9eb 0%, transparent 60%),
        var(--bg);
      line-height: 1.35;
    }

    .shell {
      width: min(1600px, 100% - 36px);
      margin: 18px auto 28px;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(8px);
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px 16px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 12px;
    }

    .title {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.01em;
      font-weight: 700;
    }

    .meta {
      color: var(--ink-soft);
      font-size: 12px;
      font-family: var(--mono);
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tab-btn {
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--ink);
      border-radius: 999px;
      padding: 8px 13px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.16s ease;
    }

    .tab-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #f7fffe;
    }

    .tab {
      display: none;
      gap: 12px;
    }

    .tab.active { display: grid; }

    .panel {
      background: color-mix(in srgb, var(--card-strong) 88%, transparent);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .panel-title {
      margin: 0;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--ink-soft);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(130px, 1fr));
      gap: 10px;
    }

    .kpi-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #ffffff;
      padding: 10px;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--ink-soft);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 21px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .control-inline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 11px;
      color: var(--ink-soft);
      font-family: var(--mono);
    }

    .control-inline select,
    .control-inline input,
    .filter-grid select,
    .filter-grid input {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      min-height: 34px;
      width: 100%;
    }

    .overview-chart {
      display: grid;
      gap: 8px;
    }

    .ov-row {
      display: grid;
      grid-template-columns: 30px 280px 1fr 120px;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px 10px;
    }

    .ov-rank {
      text-align: right;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--ink-soft);
      font-size: 12px;
    }

    .ov-model {
      min-width: 0;
    }

    .ov-model-main {
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ov-model-sub {
      font-size: 10px;
      color: var(--ink-soft);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: var(--mono);
    }

    .ov-bar {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ov-track {
      position: relative;
      flex: 1;
      height: 16px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #eff3f1;
      overflow: hidden;
    }

    .ov-fill {
      position: absolute;
      inset: 0 auto 0 0;
      width: 0;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
    }

    .ov-pct {
      height: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: flex-end;
      min-width: 44px;
      font-size: 11px;
      color: var(--ink-soft);
      font-variant-numeric: tabular-nums;
    }

    .ov-metric {
      text-align: right;
      font-size: 12px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--accent);
    }

    .rel-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .rel-list {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px;
      max-height: 280px;
      overflow: auto;
      font-size: 12px;
      font-family: var(--mono);
    }

    .rel-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px dashed #dce4e0;
    }

    .rel-item:last-child { border-bottom: 0; }

    .viewer-toolbar .filter-grid {
      display: grid;
      grid-template-columns: 1.4fr repeat(8, minmax(110px, 1fr));
      gap: 8px;
    }

    .viewer-layout {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 12px;
      align-items: start;
    }

    .group-list {
      max-height: 68vh;
      overflow: auto;
      display: grid;
      gap: 6px;
    }

    .group-item {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
      text-align: left;
    }

    .group-item.active {
      border-color: var(--accent);
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent) 44%, white);
      background: #f6fcfb;
    }

    .group-top {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .group-id {
      font-size: 11px;
      font-family: var(--mono);
      color: var(--ink-soft);
      white-space: nowrap;
    }

    .group-count {
      font-size: 10px;
      color: var(--ink-soft);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 2px 6px;
      font-family: var(--mono);
    }

    .group-question {
      font-size: 11px;
      font-weight: 600;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .group-meta {
      margin-top: 5px;
      font-size: 10px;
      color: var(--ink-soft);
      font-family: var(--mono);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .compare-header {
      display: grid;
      gap: 8px;
      margin-bottom: 10px;
    }

    .question-text {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.35;
      margin: 0;
    }

    .subtle {
      color: var(--ink-soft);
      font-size: 11px;
      font-family: var(--mono);
    }

    .compare-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
      gap: 10px;
      max-height: 72vh;
      overflow: auto;
      padding-right: 2px;
    }

    .resp-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 10px;
      display: grid;
      gap: 7px;
      min-height: 230px;
    }

    .resp-card.selected {
      border-color: var(--accent);
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent) 46%, white);
    }

    .resp-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
    }

    .resp-model {
      font-size: 12px;
      font-weight: 700;
      line-height: 1.3;
      min-width: 0;
      word-break: break-word;
    }

    .badge {
      font-size: 10px;
      font-weight: 700;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 3px 8px;
      white-space: nowrap;
      font-family: var(--mono);
    }

    .b-good { color: #0f6a4f; background: #ecf9f3; border-color: #bee4d4; }
    .b-warn { color: #8d5416; background: #fff4e8; border-color: #f0d0ad; }
    .b-bad { color: #8b332b; background: #fff1ef; border-color: #efc0bb; }
    .b-info { color: #204f80; background: #edf4fc; border-color: #c0d4ea; }
    .b-neutral { color: #4c646d; background: #f1f5f4; border-color: #d8e2df; }

    .judge-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .judge-pill {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 3px 6px;
      font-size: 10px;
      color: var(--ink-soft);
      font-family: var(--mono);
      background: #fafcfa;
      white-space: nowrap;
    }

    .resp-text {
      margin: 0;
      white-space: pre-wrap;
      font-size: 12px;
      line-height: 1.45;
      color: #1f2f36;
      max-height: 260px;
      overflow: auto;
    }

    .resp-foot {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 10px;
      color: var(--ink-soft);
      font-family: var(--mono);
    }

    .empty {
      border: 1px dashed #c8d4ce;
      border-radius: 10px;
      background: #fbfdfb;
      color: var(--ink-soft);
      text-align: center;
      padding: 16px;
      font-size: 12px;
    }

    .filter-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .errors-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .errors-table th,
    .errors-table td {
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: top;
      padding: 7px 8px;
    }

    .errors-table th {
      background: #f2f7f4;
      color: var(--ink-soft);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mono { font-family: var(--mono); }

    .btn-clear {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--ink-soft);
      cursor: pointer;
      min-height: 34px;
      padding: 0 12px;
    }

    @media (max-width: 1280px) {
      .kpi-grid { grid-template-columns: repeat(3, minmax(130px, 1fr)); }
      .viewer-toolbar .filter-grid { grid-template-columns: repeat(5, minmax(120px, 1fr)); }
      .ov-row { grid-template-columns: 26px 220px 1fr 96px; }
    }

    @media (max-width: 960px) {
      .shell { width: min(1600px, 100% - 20px); }
      .meta { max-width: 100%; text-align: left; }
      .topbar { align-items: flex-start; flex-direction: column; }
      .viewer-layout { grid-template-columns: 1fr; }
      .group-list { max-height: 42vh; }
      .kpi-grid { grid-template-columns: repeat(2, minmax(130px, 1fr)); }
      .viewer-toolbar .filter-grid { grid-template-columns: repeat(3, minmax(120px, 1fr)); }
      .ov-row { grid-template-columns: 26px 1fr; grid-template-areas: "rank model" "bar bar" "metric metric"; }
      .ov-rank { grid-area: rank; }
      .ov-model { grid-area: model; }
      .ov-bar { grid-area: bar; }
      .ov-metric { grid-area: metric; text-align: left; }
      .rel-wrap { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <h1 class="title">Bullshit Benchmark</h1>
      <div id="headerMeta" class="meta"></div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="overview">Overview</button>
      <button class="tab-btn" data-tab="viewer">Data Viewer</button>
      <button class="tab-btn" data-tab="errors">Errors</button>
    </nav>

    <section id="tab-overview" class="tab active">
      <div id="kpiGrid" class="kpi-grid"></div>

      <div class="panel">
        <div class="panel-head">
          <h2 class="panel-title">Model Quality</h2>
          <div class="control-inline">
            <select id="ovRankBy" title="Rank by">
              <option value="correct">Metric: BS Correct</option>
              <option value="agreement">Metric: Agreement</option>
              <option value="missed">Metric: BS Missed</option>
              <option value="partial">Metric: BS Partial</option>
            </select>
            <select id="ovMinAgree" title="Minimum agreement">
              <option value="0">Agreement: Any</option>
              <option value="67">Agreement: 67%+</option>
              <option value="80">Agreement: 80%+</option>
              <option value="100">Agreement: 100%</option>
            </select>
            <select id="ovOrg" title="Org"></select>
            <select id="ovReasoning" title="Reasoning"></select>
          </div>
        </div>
        <div id="overviewChart" class="overview-chart"></div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <h2 class="panel-title">Reliability</h2>
        </div>
        <div id="reliabilityWrap" class="rel-wrap"></div>
      </div>
    </section>

    <section id="tab-viewer" class="tab">
      <div class="panel viewer-toolbar">
        <div class="filter-grid">
          <input id="vfSearch" placeholder="Search" />
          <select id="vfOrg"></select>
          <select id="vfReasoning"></select>
          <select id="vfModel"></select>
          <select id="vfTechnique"></select>
          <select id="vfDomain"></select>
          <select id="vfOutcome"></select>
          <select id="vfQType"></select>
          <select id="vfRun"></select>
          <button id="vfClear" class="btn-clear">Clear</button>
        </div>
      </div>

      <div class="viewer-layout">
        <aside class="panel">
          <div class="panel-head">
            <h2 class="panel-title">Prompt Set</h2>
            <span id="groupCount" class="chip">0</span>
          </div>
          <div id="groupList" class="group-list"></div>
        </aside>

        <section class="panel">
          <div id="activeFilters" class="filter-chips"></div>
          <div id="compareHeader" class="compare-header"></div>
          <div id="compareGrid" class="compare-grid"></div>
        </section>
      </div>
    </section>

    <section id="tab-errors" class="tab">
      <div class="panel" id="errorsContainer"></div>
    </section>
  </div>

  <script>
    const DATA = __REPORT_PAYLOAD__;

    const byId = (id) => document.getElementById(id);

    function escapeHtml(value) {
      return String(value ?? "").replace(/[&<>"']/g, (ch) => {
        const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" };
        return map[ch] || ch;
      });
    }

    function toNumberOrNull(value) {
      const n = Number(value);
      return Number.isFinite(n) ? n : null;
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function fmtPct(value) {
      const n = toNumberOrNull(value);
      if (n === null) return "n/a";
      return `${Math.round(n * 100)}%`;
    }

    function fmtNum(value, decimals = 2) {
      const n = toNumberOrNull(value);
      if (n === null) return "n/a";
      return n.toFixed(decimals);
    }

    function splitModelRef(rawRef) {
      const raw = String(rawRef || "").trim();
      const slash = raw.indexOf("/");
      if (slash < 0) return { org: "unknown", model: raw || "unknown", raw };
      return {
        org: raw.slice(0, slash),
        model: raw.slice(slash + 1),
        raw,
      };
    }

    function modelReasoningLevelFromText(modelText) {
      const text = String(modelText || "");
      const match = text.match(/@reasoning=([^/\\s]+)/);
      return match ? String(match[1]).trim() : "";
    }

    function rowModelOrg(row) {
      const explicit = String(row?.model_org || "").trim();
      if (explicit) return explicit;
      return splitModelRef(row?.model).org;
    }

    function rowModelReasoning(row) {
      const explicit = String(row?.model_reasoning_level || "").trim();
      if (explicit) return explicit;
      const parsed = modelReasoningLevelFromText(row?.model);
      if (parsed) return parsed;
      const effort = String(row?.response_reasoning_effort || "").trim();
      if (effort) return effort;
      return "default";
    }

    function shortJudgeModel(model) {
      const parts = splitModelRef(model || "");
      const modelOnly = parts.model || parts.raw;
      return modelOnly.replace(/@reasoning=.*/, "");
    }

    function consensusBucket(rawConsensus) {
      const numeric = toNumberOrNull(rawConsensus);
      if (numeric === null) return null;
      return Math.floor(clamp(numeric, 0, 3) + 0.5);
    }

    function rowConsensusScore(row) {
      const fromAggregate = toNumberOrNull(row?.consensus_score);
      if (fromAggregate !== null) return fromAggregate;

      const judges = Array.isArray(row?.judges) ? row.judges : [];
      const votes = judges
        .map((judge) => (Number.isInteger(judge?.score) && !judge?.error ? judge.score : null))
        .filter((score) => Number.isInteger(score));
      if (!votes.length) return null;

      const counts = new Map();
      votes.forEach((vote) => counts.set(vote, (counts.get(vote) || 0) + 1));

      let bestScore = null;
      let bestCount = -1;
      counts.forEach((count, score) => {
        if (count > bestCount) {
          bestCount = count;
          bestScore = score;
        }
      });
      return bestScore;
    }

    function outcomeInfo(row, bucket) {
      if (!Number.isInteger(bucket)) {
        return { key: "unscored", label: "Unscored", cls: "b-neutral" };
      }

      if (row.is_control) {
        if (bucket === 3) return { key: "control_correct", label: "Control Correct", cls: "b-good" };
        if (bucket === 0) return { key: "control_incorrect", label: "Control Incorrect", cls: "b-bad" };
        return { key: "control_ambiguous", label: "Control Ambiguous", cls: "b-info" };
      }

      if (bucket === 2) return { key: "bs_correct", label: "BS Correct", cls: "b-good" };
      if (bucket === 1) return { key: "bs_partial", label: "BS Partial", cls: "b-warn" };
      if (bucket === 0) return { key: "bs_missed", label: "BS Missed", cls: "b-bad" };
      return { key: "bs_invalid", label: "BS Invalid", cls: "b-info" };
    }

    function getRowState(row) {
      const rawConsensus = rowConsensusScore(row);
      const consensus = consensusBucket(rawConsensus);
      const judges = Array.isArray(row?.judges) ? row.judges : [];
      const judgeScores = judges.map((judge) => (Number.isInteger(judge?.score) && !judge?.error ? judge.score : null));
      const allPresent = judgeScores.length > 0 && judgeScores.every((score) => Number.isInteger(score));
      const allAgree = allPresent && judgeScores.every((score) => score === judgeScores[0]);
      const outcome = outcomeInfo(row, consensus);
      return {
        consensusRaw: rawConsensus,
        consensus,
        outcome,
        judgeScores,
        allPresent,
        allAgree,
      };
    }

    function computeBoard(rows) {
      const byModel = new Map();

      rows.forEach((row) => {
        const model = String(row.model || "unknown");
        if (!byModel.has(model)) {
          const modelParts = splitModelRef(model);
          byModel.set(model, {
            model,
            modelOrg: modelParts.org,
            modelName: modelParts.model,
            reasoning: rowModelReasoning(row),
            total: 0,
            errors: 0,
            nonsenseTotal: 0,
            controlTotal: 0,
            correct: 0,
            partial: 0,
            missed: 0,
            invalid: 0,
            controlCorrect: 0,
            controlIncorrect: 0,
            agreeCount: 0,
            agreeTotal: 0,
            questions: new Set(),
            runs: new Set(),
          });
        }

        const stats = byModel.get(model);
        const state = getRowState(row);

        stats.total += 1;
        if (row.question_id) stats.questions.add(String(row.question_id));
        if (row.run_index !== null && row.run_index !== undefined && row.run_index !== "") {
          stats.runs.add(String(row.run_index));
        }
        if (String(row.status || "") === "error") stats.errors += 1;

        if (state.allPresent) {
          stats.agreeTotal += 1;
          if (state.allAgree) stats.agreeCount += 1;
        }

        if (row.is_control) {
          stats.controlTotal += 1;
          if (state.consensus === 3) stats.controlCorrect += 1;
          else if (state.consensus === 0) stats.controlIncorrect += 1;
        } else {
          stats.nonsenseTotal += 1;
          if (state.consensus === 2) stats.correct += 1;
          else if (state.consensus === 1) stats.partial += 1;
          else if (state.consensus === 0) stats.missed += 1;
          else if (state.consensus === 3) stats.invalid += 1;
        }
      });

      const board = Array.from(byModel.values()).map((stats) => {
        const nonsenseTotal = stats.nonsenseTotal || 0;
        return {
          model: stats.model,
          modelOrg: stats.modelOrg,
          modelName: stats.modelName,
          reasoning: stats.reasoning,
          total: stats.total,
          errors: stats.errors,
          nonsenseTotal,
          controlTotal: stats.controlTotal,
          correct: stats.correct,
          partial: stats.partial,
          missed: stats.missed,
          invalid: stats.invalid,
          controlCorrect: stats.controlCorrect,
          controlIncorrect: stats.controlIncorrect,
          correctRate: nonsenseTotal > 0 ? stats.correct / nonsenseTotal : null,
          partialRate: nonsenseTotal > 0 ? stats.partial / nonsenseTotal : null,
          missedRate: nonsenseTotal > 0 ? stats.missed / nonsenseTotal : null,
          invalidRate: nonsenseTotal > 0 ? stats.invalid / nonsenseTotal : null,
          agreementRate: stats.agreeTotal > 0 ? stats.agreeCount / stats.agreeTotal : null,
          controlCorrectRate: stats.controlTotal > 0 ? stats.controlCorrect / stats.controlTotal : null,
          questionCount: stats.questions.size,
          runCount: stats.runs.size,
        };
      });

      board.sort((a, b) => {
        const ac = a.correctRate ?? -1;
        const bc = b.correctRate ?? -1;
        if (bc !== ac) return bc - ac;
        const am = a.missedRate ?? 1;
        const bm = b.missedRate ?? 1;
        if (am !== bm) return am - bm;
        return String(a.model).localeCompare(String(b.model));
      });

      return board;
    }

    function renderHeaderMeta(rows) {
      const nonsense = rows.filter((row) => !row.is_control).length;
      const control = rows.filter((row) => row.is_control).length;
      const uniqueQuestions = new Set(rows.map((row) => row.question_id).filter(Boolean)).size;
      const uniqueRuns = new Set(rows.map((row) => row.run_index).filter((run) => run !== null && run !== undefined && run !== "")).size;
      const judgeCount = Array.isArray(DATA.judge_runs) ? DATA.judge_runs.length : 0;
      const stamp = String(DATA.meta?.generated_at_utc || "");
      const controlPart = control > 0 ? ` | control ${control}` : "";
      byId("headerMeta").textContent = `${stamp} | rows ${rows.length} | nonsense ${nonsense}${controlPart} | q ${uniqueQuestions} | runs ${uniqueRuns} | judges ${judgeCount}`;
    }

    function renderOverview(rows) {
      const board = computeBoard(rows);

      const nonsenseRows = rows.filter((row) => !row.is_control);
      const totalCorrect = nonsenseRows.filter((row) => getRowState(row).consensus === 2).length;
      const totalAgreeRows = rows.filter((row) => getRowState(row).allPresent);
      const totalAgree = totalAgreeRows.filter((row) => getRowState(row).allAgree).length;
      const errorCount = rows.filter((row) => String(row.status || "") === "error").length;

      byId("kpiGrid").innerHTML = [
        { label: "Models", value: board.length },
        { label: "Rows", value: rows.length },
        { label: "BS Correct", value: nonsenseRows.length ? `${Math.round((totalCorrect / nonsenseRows.length) * 100)}%` : "n/a" },
        { label: "Agreement", value: totalAgreeRows.length ? `${Math.round((totalAgree / totalAgreeRows.length) * 100)}%` : "n/a" },
        { label: "Errors", value: errorCount },
      ].map((card) => `
        <div class="kpi-card">
          <div class="kpi-label">${escapeHtml(card.label)}</div>
          <div class="kpi-value">${escapeHtml(card.value)}</div>
        </div>
      `).join("");

      const rankBy = String(byId("ovRankBy").value || "correct");
      const minAgreement = Number(byId("ovMinAgree").value || "0") / 100;
      const orgFilter = String(byId("ovOrg").value || "");
      const reasoningFilter = String(byId("ovReasoning").value || "");

      const sorted = [...board]
        .filter((row) => !orgFilter || row.modelOrg === orgFilter)
        .filter((row) => !reasoningFilter || row.reasoning === reasoningFilter)
        .filter((row) => row.agreementRate === null || row.agreementRate >= minAgreement)
        .sort((a, b) => {
          const valueFor = (stats) => {
            if (rankBy === "missed") return stats.missedRate ?? 1;
            if (rankBy === "partial") return stats.partialRate ?? -1;
            if (rankBy === "agreement") return stats.agreementRate ?? -1;
            return stats.correctRate ?? -1;
          };
          const av = valueFor(a);
          const bv = valueFor(b);

          if (rankBy === "missed") {
            if (av !== bv) return av - bv;
          } else if (av !== bv) {
            return bv - av;
          }

          return String(a.model).localeCompare(String(b.model));
        });

      if (!sorted.length) {
        byId("overviewChart").innerHTML = '<div class="empty">No models match current overview controls.</div>';
      } else {
        byId("overviewChart").innerHTML = sorted.map((stats, index) => {
          const metricRate =
            rankBy === "missed"
              ? stats.missedRate
              : rankBy === "partial"
                ? stats.partialRate
                : rankBy === "agreement"
                  ? stats.agreementRate
                  : stats.correctRate;
          const metricPct = toNumberOrNull(metricRate) === null ? 0 : clamp(metricRate * 100, 0, 100);
          const metricText =
            rankBy === "missed"
              ? `missed ${fmtPct(stats.missedRate)}`
              : rankBy === "partial"
                ? `partial ${fmtPct(stats.partialRate)}`
                : rankBy === "agreement"
                  ? `agree ${fmtPct(stats.agreementRate)}`
                  : `correct ${fmtPct(stats.correctRate)}`;

          return `
            <div class="ov-row">
              <div class="ov-rank">${index + 1}</div>
              <div class="ov-model">
                <div class="ov-model-main" title="${escapeHtml(stats.model)}">${escapeHtml(stats.modelName)}</div>
                <div class="ov-model-sub">${escapeHtml(stats.modelOrg)} | reasoning ${escapeHtml(stats.reasoning)} | q ${stats.questionCount} | run ${stats.runCount}</div>
              </div>
              <div class="ov-bar" title="${escapeHtml(metricText)}">
                <span class="ov-track">
                  <span class="ov-fill" style="width:${metricPct}%;"></span>
                </span>
                <span class="ov-pct">${escapeHtml(fmtPct(metricRate))}</span>
              </div>
              <div class="ov-metric">${escapeHtml(metricText)}</div>
            </div>
          `;
        }).join("");
      }

      const reliability = DATA.reliability || {};
      const left = `
        <div class="kpi-card">
          <div class="kpi-label">Average Pairwise</div>
          <div class="kpi-value">${escapeHtml(fmtPct(reliability.average_pairwise_agreement))}</div>
        </div>
        <div class="kpi-card" style="margin-top:8px;">
          <div class="kpi-label">Krippendorff Alpha</div>
          <div class="kpi-value">${escapeHtml(fmtNum(reliability.krippendorff_alpha_ordinal, 3))}</div>
        </div>
      `;

      const pairwise = Array.isArray(reliability.pairwise) ? reliability.pairwise : [];
      const right = pairwise.length
        ? `<div class="rel-list">${pairwise.map((entry) => `
            <div class="rel-item">
              <span>${escapeHtml(entry.judge_i)} vs ${escapeHtml(entry.judge_j)}</span>
              <span>${escapeHtml(fmtPct(entry.agreement_rate))}</span>
            </div>
          `).join("")}</div>`
        : '<div class="empty">No pairwise reliability rows.</div>';

      byId("reliabilityWrap").innerHTML = `<div>${left}</div><div>${right}</div>`;
    }

    function getViewerFilters() {
      return {
        search: String(byId("vfSearch").value || "").trim().toLowerCase(),
        org: String(byId("vfOrg").value || ""),
        reasoning: String(byId("vfReasoning").value || ""),
        model: String(byId("vfModel").value || ""),
        technique: String(byId("vfTechnique").value || ""),
        domain: String(byId("vfDomain").value || ""),
        outcome: String(byId("vfOutcome").value || ""),
        qType: String(byId("vfQType").value || ""),
        run: String(byId("vfRun").value || ""),
      };
    }

    function outcomeMatchesFilter(row, state, outcomeFilter) {
      if (!outcomeFilter) return true;
      if (outcomeFilter === "bs_correct") return !row.is_control && state.consensus === 2;
      if (outcomeFilter === "bs_partial") return !row.is_control && state.consensus === 1;
      if (outcomeFilter === "bs_missed") return !row.is_control && state.consensus === 0;
      if (outcomeFilter === "bs_invalid") return !row.is_control && state.consensus === 3;
      if (outcomeFilter === "control_correct") return row.is_control && state.consensus === 3;
      if (outcomeFilter === "control_incorrect") return row.is_control && state.consensus === 0;
      if (outcomeFilter === "judges_disagree") return state.allPresent && !state.allAgree;
      if (outcomeFilter === "judges_incomplete") return !state.allPresent;
      if (outcomeFilter === "errors") return String(row.status || "") === "error";
      return true;
    }

    function rowMatchesViewerFilters(row, filters) {
      const state = getRowState(row);
      if (filters.org && rowModelOrg(row) !== filters.org) return false;
      if (filters.reasoning && rowModelReasoning(row) !== filters.reasoning) return false;
      if (filters.model && String(row.model || "") !== filters.model) return false;
      if (filters.technique && String(row.technique || "") !== filters.technique) return false;
      if (filters.domain && String(row.domain || "") !== filters.domain) return false;
      if (filters.run && String(row.run_index ?? "") !== filters.run) return false;
      if (filters.qType === "nonsense" && row.is_control) return false;
      if (filters.qType === "control" && !row.is_control) return false;
      if (!outcomeMatchesFilter(row, state, filters.outcome)) return false;

      if (filters.search) {
        const judgeText = Array.isArray(row.judges)
          ? row.judges.map((judge) => String(judge.justification || "")).join(" ")
          : "";
        const blob = [
          row.model,
          row.question_id,
          row.question,
          row.response_text,
          row.nonsensical_element,
          row.technique,
          row.domain,
          judgeText,
          state.outcome.label,
        ].join(" ").toLowerCase();
        if (!blob.includes(filters.search)) return false;
      }

      return true;
    }

    function buildGroups(rows) {
      const map = new Map();
      rows.forEach((row) => {
        const key = `${String(row.question_id || "unknown")}::${String(row.run_index ?? "")}`;
        if (!map.has(key)) {
          map.set(key, {
            key,
            question_id: row.question_id,
            run_index: row.run_index,
            question: row.question,
            technique: row.technique,
            domain: row.domain,
            rows: [],
          });
        }
        map.get(key).rows.push(row);
      });

      return Array.from(map.values()).sort((a, b) => {
        const qa = String(a.question_id || "");
        const qb = String(b.question_id || "");
        if (qa !== qb) return qa.localeCompare(qb);
        const ra = Number(a.run_index || 0);
        const rb = Number(b.run_index || 0);
        return ra - rb;
      });
    }

    let selectedGroupKey = "";

    function renderGroupList(groups) {
      byId("groupCount").textContent = `${groups.length}`;

      if (!groups.length) {
        byId("groupList").innerHTML = '<div class="empty">No matching prompt sets.</div>';
        return;
      }

      if (!selectedGroupKey || !groups.some((group) => group.key === selectedGroupKey)) {
        selectedGroupKey = groups[0].key;
      }

      byId("groupList").innerHTML = groups.map((group) => {
        const states = group.rows.map((row) => getRowState(row));
        const correct = states.filter((state, idx) => !group.rows[idx].is_control && state.consensus === 2).length;
        const missed = states.filter((state, idx) => !group.rows[idx].is_control && state.consensus === 0).length;
        const disagree = states.filter((state) => state.allPresent && !state.allAgree).length;

        return `
          <button class="group-item ${group.key === selectedGroupKey ? "active" : ""}" data-group-key="${escapeHtml(group.key)}">
            <div class="group-top">
              <span class="group-id">${escapeHtml(group.question_id)} / run ${escapeHtml(group.run_index)}</span>
              <span class="group-count">${group.rows.length} rows</span>
            </div>
            <div class="group-question">${escapeHtml(group.question || "")}</div>
            <div class="group-meta">
              <span>2:${correct}</span>
              <span>0:${missed}</span>
              <span>disagree:${disagree}</span>
            </div>
          </button>
        `;
      }).join("");

      byId("groupList").querySelectorAll("[data-group-key]").forEach((button) => {
        button.addEventListener("click", () => {
          selectedGroupKey = button.getAttribute("data-group-key") || "";
          renderViewer();
        });
      });
    }

    function renderCompare(groups) {
      if (!groups.length) {
        byId("compareHeader").innerHTML = "";
        byId("compareGrid").innerHTML = '<div class="empty">No rows available.</div>';
        return;
      }

      const group = groups.find((entry) => entry.key === selectedGroupKey) || groups[0];
      selectedGroupKey = group.key;

      byId("compareHeader").innerHTML = `
        <p class="question-text">${escapeHtml(group.question || "")}</p>
        <div class="subtle">${escapeHtml(group.question_id)} | run ${escapeHtml(group.run_index)} | ${escapeHtml(group.technique || "")} | ${escapeHtml(group.domain || "")}</div>
      `;

      const sortedRows = [...group.rows].sort((a, b) => {
        const sa = getRowState(a).consensus;
        const sb = getRowState(b).consensus;
        const aScore = Number.isInteger(sa) ? sa : -1;
        const bScore = Number.isInteger(sb) ? sb : -1;
        if (bScore !== aScore) return bScore - aScore;
        return String(a.model || "").localeCompare(String(b.model || ""));
      });

      byId("compareGrid").innerHTML = sortedRows.map((row) => {
        const state = getRowState(row);
        const judges = Array.isArray(row.judges) ? row.judges : [];
        const selectedClass = row.sample_id === selectedGroupKey ? "selected" : "";
        const scoreText = Number.isInteger(state.consensus)
          ? `score ${state.consensus}`
          : "score n/a";

        const judgeHtml = judges.map((judge) => {
          const score = Number.isInteger(judge.score) ? judge.score : "n/a";
          const err = judge.error ? " err" : "";
          return `<span class="judge-pill">${escapeHtml(shortJudgeModel(judge.model))}:${escapeHtml(score)}${escapeHtml(err)}</span>`;
        }).join("");

        return `
          <article class="resp-card ${selectedClass}">
            <div class="resp-head">
              <div class="resp-model">${escapeHtml(row.model || "")}</div>
              <span class="badge ${escapeHtml(state.outcome.cls)}">${escapeHtml(state.outcome.label)} | ${escapeHtml(scoreText)}</span>
            </div>
            <div class="judge-strip">${judgeHtml || '<span class="judge-pill">no judges</span>'}</div>
            <pre class="resp-text">${escapeHtml(row.response_text || "")}</pre>
            <div class="resp-foot">
              <span>${escapeHtml(row.sample_id || "")}</span>
              <span>${escapeHtml(String(row.status || "ok"))}</span>
            </div>
          </article>
        `;
      }).join("");
    }

    function renderActiveFilterChips(filters) {
      const chips = [];
      const addChip = (label, value) => {
        if (value) chips.push(`<span class="chip">${escapeHtml(label)}: ${escapeHtml(value)}</span>`);
      };

      addChip("search", filters.search);
      addChip("org", filters.org);
      addChip("reasoning", filters.reasoning);
      addChip("model", filters.model);
      addChip("technique", filters.technique);
      addChip("domain", filters.domain);
      addChip("outcome", filters.outcome);
      addChip("type", filters.qType);
      addChip("run", filters.run);

      byId("activeFilters").innerHTML = chips.length ? chips.join("") : '<span class="chip">filters: none</span>';
    }

    function renderViewer() {
      const rows = Array.isArray(DATA.rows) ? DATA.rows : [];
      const filters = getViewerFilters();
      const filteredRows = rows.filter((row) => rowMatchesViewerFilters(row, filters));
      const groups = buildGroups(filteredRows);
      renderActiveFilterChips(filters);
      renderGroupList(groups);
      renderCompare(groups);
    }

    function renderErrors() {
      const errors = Array.isArray(DATA.errors) ? DATA.errors : [];
      if (!errors.length) {
        byId("errorsContainer").innerHTML = '<div class="empty">No errors recorded.</div>';
        return;
      }

      byId("errorsContainer").innerHTML = `
        <table class="errors-table">
          <thead>
            <tr>
              <th>Phase</th>
              <th>Sample</th>
              <th>Model</th>
              <th>Question</th>
              <th>Judge</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody>
            ${errors.map((entry) => `
              <tr>
                <td>${escapeHtml(entry.phase || "")}</td>
                <td class="mono">${escapeHtml(entry.sample_id || "")}</td>
                <td class="mono">${escapeHtml(entry.model || "")}</td>
                <td class="mono">${escapeHtml(entry.question_id || "")}</td>
                <td class="mono">${escapeHtml(entry.judge_model || "")}</td>
                <td>${escapeHtml(entry.error || "")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function initTabs() {
      document.querySelectorAll(".tab-btn").forEach((button) => {
        button.addEventListener("click", () => {
          const target = String(button.getAttribute("data-tab") || "");
          document.querySelectorAll(".tab-btn").forEach((btn) => btn.classList.toggle("active", btn === button));
          document.querySelectorAll(".tab").forEach((tab) => tab.classList.toggle("active", tab.id === `tab-${target}`));
        });
      });
    }

    function fillSelect(id, values, firstLabel) {
      const node = byId(id);
      const current = String(node.value || "");
      node.innerHTML = [`<option value="">${escapeHtml(firstLabel)}</option>`, ...values.map((value) => `<option value="${escapeHtml(value)}">${escapeHtml(value)}</option>`)].join("");
      if (current && values.includes(current)) node.value = current;
    }

    function populateOverviewFilters(rows) {
      const board = computeBoard(rows);
      fillSelect("ovOrg", Array.from(new Set(board.map((row) => String(row.modelOrg || "")).filter(Boolean))).sort(), "Org: All");
      fillSelect("ovReasoning", Array.from(new Set(board.map((row) => String(row.reasoning || "")).filter(Boolean))).sort(), "Reasoning: All");
    }

    function populateViewerFilters(rows) {
      fillSelect("vfOrg", Array.from(new Set(rows.map((row) => rowModelOrg(row)).filter(Boolean))).sort(), "Org");
      fillSelect("vfReasoning", Array.from(new Set(rows.map((row) => rowModelReasoning(row)).filter(Boolean))).sort(), "Reasoning");
      fillSelect("vfModel", Array.from(new Set(rows.map((row) => String(row.model || "")).filter(Boolean))).sort(), "Model");
      fillSelect("vfTechnique", Array.from(new Set(rows.map((row) => String(row.technique || "")).filter(Boolean))).sort(), "Technique");
      fillSelect("vfDomain", Array.from(new Set(rows.map((row) => String(row.domain || "")).filter(Boolean))).sort(), "Domain");
      fillSelect("vfRun", Array.from(new Set(rows.map((row) => String(row.run_index ?? "")).filter((value) => value))).sort(), "Run");

      byId("vfOutcome").innerHTML = [
        '<option value="">Outcome</option>',
        '<option value="bs_correct">BS Correct</option>',
        '<option value="bs_partial">BS Partial</option>',
        '<option value="bs_missed">BS Missed</option>',
        '<option value="bs_invalid">BS Invalid</option>',
        '<option value="judges_disagree">Judges Disagree</option>',
        '<option value="judges_incomplete">Judges Incomplete</option>',
        '<option value="errors">Errors</option>',
      ].join("");

      byId("vfQType").innerHTML = [
        '<option value="">Question Type</option>',
        '<option value="nonsense">Nonsense</option>',
      ].join("");
    }

    function bindViewerFilterEvents() {
      ["vfSearch", "vfOrg", "vfReasoning", "vfModel", "vfTechnique", "vfDomain", "vfOutcome", "vfQType", "vfRun"].forEach((id) => {
        const node = byId(id);
        node.addEventListener("input", renderViewer);
        node.addEventListener("change", renderViewer);
      });

      byId("vfClear").addEventListener("click", () => {
        ["vfSearch", "vfOrg", "vfReasoning", "vfModel", "vfTechnique", "vfDomain", "vfOutcome", "vfQType", "vfRun"].forEach((id) => {
          const node = byId(id);
          if (node.tagName === "SELECT") node.selectedIndex = 0;
          else node.value = "";
        });
        renderViewer();
      });
    }

    function boot() {
      const rows = Array.isArray(DATA.rows) ? DATA.rows : [];
      renderHeaderMeta(rows);
      initTabs();
      populateOverviewFilters(rows);
      populateViewerFilters(rows);
      bindViewerFilterEvents();
      renderOverview(rows);
      renderViewer();
      renderErrors();

      byId("ovRankBy").addEventListener("change", () => renderOverview(rows));
      byId("ovMinAgree").addEventListener("change", () => renderOverview(rows));
      byId("ovOrg").addEventListener("change", () => renderOverview(rows));
      byId("ovReasoning").addEventListener("change", () => renderOverview(rows));
    }

    boot();
  </script>
</body>
</html>
